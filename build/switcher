#! /bin/bash
# 
# basic build system for editing. 
# creds are kept above repo. 
# No flags gets us blank configs for repo

function startMAMP {
	echo "starting MAMP"
	$MAMPDir/bin/start.sh
	open -nW $MAMPDir/MAMP.app --args -AppCommandLineArg
	$MAMPDir/bin/stop.sh

}

function blankem {
	echo "secrets blanked"
	cp $pathToSecrets/class.database_blank.php ../includes/class.database.php
	cp $pathToSecrets/AdminSettings_blank.php ../wiki/AdminSettings.php
	cp $pathToSecrets/LocalSettings_blank.php ../wiki/LocalSettings.php
	cp $pathToSecrets/wp-config_blank.php ../blog/wp-config.php
}

function exportSQL {
	echo "exportSQL selected"
	$MAMPDir/bin/start.sh
	open /Applications/MAMP/MAMP.app --args -AppCommandLineArg
	echo "must have an sql server to backup - wait 5 secs for MAMP to startup"
	SECS=5
	while [[ 0 -ne $SECS ]]; do
    	echo "$SECS.."
    	sleep 1
    	SECS=$[$SECS-1]
	done
	echo "local MySQL password please:"
  	$mySQLDir/mysqldump -u root -p "$db" > "$sqlFolder/$db".sql && {
  		echo "Success - dababase saved to "$sqlFolder/$db".sql "
  		read -n1 -r -p "Press any key to continue..."
  		$MAMPDir/bin/stop.sh
  	}
  	
}

if [[ "$1" = "--local" ]]; then
	echo "local selected"
	cp $pathToSecrets/class.database_local.php ../includes/class.database.php
	cp $pathToSecrets/AdminSettings_local.php ../wiki/AdminSettings.php
	cp $pathToSecrets/LocalSettings_local.php ../wiki/LocalSettings.php
	cp $pathToSecrets/wp-config_local.php ../blog/wp-config.php
	echo $warn
	startMAMP

elif [[ "$1" = "--exportSQL" ]]; then
	exportSQL

elif [[ "$1" = "--live" ]]; then
	echo "live selected"
	# first export the sql
	exportSQL
	echo "changing the config files to the live versions"
	cp $pathToSecrets/class.database.php ../includes/class.database.php
	cp $pathToSecrets/AdminSettings.php ../wiki/AdminSettings.php
	cp $pathToSecrets/LocalSettings.php ../wiki/LocalSettings.php
	cp $pathToSecrets/wp-config.php ../blog/wp-config.php
	echo "syncing the website"
	./site
	echo "next, syncing the databaes"
	./database
	exit

elif [[ "$1" = "--blankem" ]]; then
	echo "blanking and exiting"
	blankem
	exit

elif [[ "$1" = "--localCMD" ]]; then
	echo "entering command line"
	$MAMPDir/bin/start.sh
	open /Applications/MAMP/MAMP.app --args -AppCommandLineArg
	echo "TYPE THIS: $mySQLDir/mysql -u root -p "$db" -e \"\""
	echo $warn
	exit
else
	echo "no flags"
	blankem	
fi

# always blank when we fall through
echo "shutting down and blanking"; 
blankem; 


