#!/bin/bash

. switcher

let failedTests=0
testValue="testValue"

# test files will live in serets dir
testFile="../../secrets/secretsRegexTestFile"
resultsFile="${testFile}Result"

function runATest {
	configKey="$1"
	replacePHPConfig "$configKey" "$testValue" "$resultsFile"
	if (($?==1)); then	
		echo "Test failed - config key was empty"
		((failedTests++))
	else
		testResult=$( { cat $resultsFile && echo "<?php echo $testValue ?>" ;}  | php )
		if [[ $testResult == $testValue ]]; then
			echo "Success - "$configKey" result is $testResult"
		else 
			echo "Failiure - "$configKey" test result is $testResult"
			((failedTests++))
		fi
	fi
}

# Before
echo "get new results file (copying $testFile to $resultsFile)"
cp $testFile $resultsFile
echo "Refreshed $resultsFile - Do you want to run the tests? [y/n]" && read answer
if echo "$answer" | grep -q "^y" 
	then echo "continuing"
	else echo "exiting" && exit
fi

# Run tests
echo "Test Batch 1 - replace AdminSettings.php"
runATest '$wgDBadminpassword' 

# After
if (( failedTests > 0 )); then 
	echo "Problems found - number of failed tests is $failedTests, investigate"
else
	echo "All tests seemed to pass"
fi

