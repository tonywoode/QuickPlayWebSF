#!/bin/bash
secretsDir="../../secrets/"
configFile="${secretsDir}local.cfg"
# test files will live in serets dir
testFile="secretsRegexTestFile"
# don't allow results file to enter the repo
resultsFile="${secretsDir}${testFile}Result"

. $configFile
. switcher

let failedTests=0
defaultTestValue="intendedValue"
intendedValue=$defaultTestValue

function getAPHPConfigValue {
	fileToScan=$1
	keyToFind=$2
	echo $( { cat $fileToScan && echo "<?php echo $keyToFind ?>"; }	| sed s/this-\>// | php ) 
	# the sed takes out object context in php var names, in order to test
}

function testAConfigReplacement {
	testResult=$(getAPHPConfigValue "$resultsFile" "$keyToRead")
		if [[ $testResult == $intendedValue ]]; then
			echo "Success" 
		else 
			echo "Failiure"
			((failedTests++))
		fi
		echo "$keyToRead test result is $testResult"
}

function runAPHPVariableTest {
	keyToRead="$1"
	valueToWrite="$2"
	outputFile="$3"
	replacePHPConfig "$keyToRead" "$valueToWrite" "$outputFile"
	if (($?==1)); then	
		echo "Test failed - config key was empty"
		((failedTests++))
	else
		testAConfigReplacement 
	fi
}

function runAPHPConstantTest {
	keyToRead="$1"
	valueToWrite="$2"
	outputFile="$3"
	replacePHPConstant "$keyToRead" "$valueToWrite" "$outputFile"
	if (($?==1)); then	
		echo "Test failed - config key was empty"
		((failedTests++))
	else
		testAConfigReplacement
	fi
}

# Before
echo "get new results file (copying $testFile to $resultsFile)"
cp $testFile $resultsFile
echo "Refreshed $resultsFile - Do you want to run the tests? [y/n]" && read answer
if echo "$answer" | grep -q "^y" 
	then echo "continuing"
	else echo "exiting" && exit
fi

# Run tests
echo "Test Batch 1 - replace AdminSettings.php"
keys=('$wgDBadminpassword' '$wgDBadminuser')
for key in "${keys[@]}"; do
	runAPHPVariableTest "$key" "$intendedValue" "$resultsFile" 
done

echo "Test Batch 2 - replace LocalSettings.php"
keys=('$wgDBserver' '$wgDBname' '$wgDBuser' '$wgDBpassword' '$wgDBprefix')
for key in "${keys[@]}"; do
	runAPHPVariableTest "$key" "$intendedValue" "$resultsFile" 
done

echo "Test Batch 3 - replace Class.database.php"
keys=('$this->dbhost' '$this->dbport' '$this->dbusername' '$this->dbpassword' '$this->dbname')
for key in "${keys[@]}"; do
	runAPHPVariableTest "$key" "$intendedValue" "$resultsFile" 
done

echo "Test Batch 4 - replace wp-config/php"
keys=('DB_NAME' 'DB_USER' 'DB_PASSWORD' 'DB_HOST') 
for key in "${keys[@]}"; do
	runAPHPConstantTest "$key" "$intendedValue" "$resultsFile" 
done

echo "Test Batch 5- Replace with actual values from the secrets file"
# let's start with Class.database.php
realConfigFile="${secretsDir}live.php"
keysToReplace=('$this->dbhost' '$this->dbport' '$this->dbusername' '$this->dbpassword' '$this->dbname')

for key in "${keysToReplace[@]}"; do
	thisValue=$(getAPHPConfigValue "$realConfigFile" "$key")
	runAPHPVariableTest "$key" "$thisValue" "$resultsFile" 
done

echo "Test Batch 6 - check dummy vars haven't been changed"
resultExpectedFromTestVar="bwahha"
intendedValue=$resultExpectedFromTestVar # remember to rest intendedValue to default at the end of this batch
keyToRead='$wgDBRandomString'; 
testAConfigReplacement

#test the constant too
keyToRead='DB_RANDOM'; 
resultExpectedFromTestConst='mypass'
intendedValue=$resultExpectedFromTestConst
testAConfigReplacement
#reset intendedValue
intendedValue=$defaultTestValue

# After
echo "**********FINISHED***********"
if (( failedTests > 0 )); then 
	echo "Problems found - number of failed tests is $failedTests, investigate"
else
	echo "All tests seemed to pass ok"
fi
echo "check $resultsFile for output" 
echo "*****************************"
