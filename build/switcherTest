#!/bin/bash
secretsDir="../../secrets/"
configFile="${secretsDir}local.cfg"
# test files will live in serets dir
testFile="secretsRegexTestFile"
# don't allow results file to enter the repo
resultsFile="${secretsDir}${testFile}Result"

. $configFile
. switcher

let failedTests=0
testValue="testValue"
testVar='$wgDBRandomString'
resultExpectedFromTestVar="bwahha";
testConst='DB_RANDOM'
resultExpectedFromTestConst='mypass';	

function getAPHPConfigValue {
echo $( { cat $resultsFile && echo "<?php echo $1 ?>"; }	| sed s/this-\>// | php ) 
	 # take out object context in php var names, in order to test
}

function runAPHPVariableTest {
	configKey="$1"
	replacePHPConfig "$configKey" "$testValue" "$resultsFile"
	if (($?==1)); then	
		echo "Test failed - config key was empty"
		((failedTests++))
	else
		testResult=$(getAPHPConfigValue $configKey)
		if [[ $testResult == $testValue ]]; then
			echo "Success - "$configKey" result is $testResult"
		else 
			echo "Failiure - "$configKey" test result is $testResult"
			((failedTests++))
		fi
	fi
}

function runAPHPConstantTest {
	configKey="$1"
	replacePHPConstant "$configKey" "$testValue" "$resultsFile"
	if (($?==1)); then	
		echo "Test failed - config key was empty"
		((failedTests++))
	else
		testResult=$(getAPHPConfigValue $configKey)
		if [[ $testResult == $testValue ]]; then
			echo "Success - "$configKey" result is $testResult"
		else 
			echo "Failiure - "$configKey" test result is $testResult"
			((failedTests++))
		fi
	fi
}

# Before
echo "get new results file (copying $testFile to $resultsFile)"
cp $testFile $resultsFile
echo "Refreshed $resultsFile - Do you want to run the tests? [y/n]" && read answer
if echo "$answer" | grep -q "^y" 
	then echo "continuing"
	else echo "exiting" && exit
fi

# Run tests
echo "Test Batch 1 - replace AdminSettings.php"
runAPHPVariableTest '$wgDBadminpassword' 
runAPHPVariableTest '$wgDBadminuser'

echo "Test Batch 2 - replace LocalSettings.php"
runAPHPVariableTest '$wgDBserver'
runAPHPVariableTest '$wgDBname'
runAPHPVariableTest '$wgDBuser'
runAPHPVariableTest '$wgDBpassword'
runAPHPVariableTest '$wgDBprefix'

echo "Test Batch 3 - replace Class.database.php"
runAPHPVariableTest '$this->dbhost'
runAPHPVariableTest '$this->dbport'
runAPHPVariableTest '$this->dbusername'
runAPHPVariableTest '$this->dbpassword'
runAPHPVariableTest '$this->dbname'

echo "Test Batch 4 - replace wp-config/php"
runAPHPConstantTest 'DB_NAME'
runAPHPConstantTest 'DB_USER'
runAPHPConstantTest 'DB_PASSWORD'
runAPHPConstantTest 'DB_HOST'

echo "Test Batch 5 - check dummy vars haven't been changed"
testVarResult=$(getAPHPConfigValue $testVar)
echo "test var result is $testVarResult"
if [[ $testVarResult == $resultExpectedFromTestVar ]]; then
	echo "Success - "$testVar" result is $resultExpectedFromTestVar"
else 
	echo "Failiure - "$testVar" test result is $resultExpectedFromTestVar"
	((failedTests++))
fi

# After
if (( failedTests > 0 )); then 
	echo "Problems found - number of failed tests is $failedTests, investigate"
else
	echo "All tests seemed to pass"
fi

