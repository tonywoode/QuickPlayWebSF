#!/bin/bash

# this appeared to be the best non-screen/tmux/expect solution
# http://stackoverflow.com/questions/7114990/pseudo-terminal-will-not-be-allocated-because-stdin-is-not-a-terminal


# NOTE: Dupes of env var names - need to copy in environment varibles to the ssh session
# http://stackoverflow.com/questions/4409951/can-i-forward-env-variables-over-ssh

#login via ssh then export an sql to workingFolder
echo "I need the Remote database password please:"
read -s secret

DumpTheDB="$SSHEnvVars $( cat <<EOT
	stty -echo
	echo "directory changed to:"; pwd
	echo "dumping the LIVE database to "$db"OLD.sql"
	mysqldump -h mysql-q -u "$dbuser" -p$secret --opt "$db" --password=$secret > "$db"OLD.sql && echo "database dumped onto remote server, let's transfer the DBs across..."
	stty echo
EOT
)"
./exp ssh $sflogin "$DumpTheDB"

# copy the old databse off
echo "backing up the current LIVE database backup "$db"OLD.sql to $sqlArchiveFile"
#see here https://sourceforge.net/p/forge/documentation/File%20Management/#access-paths
rsync -P $sflogin:/home/project-web/quickplay/"$db"OLD.sql "$sqlArchiveFile".sql 

#TODO: http://stackoverflow.com/questions/12845206/check-if-file-exists-on-remote-host-with-ssh/
#Upload new sql

echo "Transferring your local db to the server"
rsync -P "$sqlLiveFile" $sflogin:/home/project-web/quickplay/"$db".sql

replaceDB="$SSHEnvVars $( cat <<EOT
	echo drop the old db, make a new one, and populate it with the sql
	stty -echo
	mysql -h mysql-q -u "$dbuser" -p$secret -e "DROP DATABASE "$db";"
	mysql -h mysql-q -u "$dbuser" -p$secret -e "CREATE DATABASE "$db";"
	mysql -h mysql-q -u "$dbuser" -p$secret "$db" < "$db".sql;
	stty echo
	echo done
EOT
)"
./exp ssh $sflogin "$replaceDB"

echo "done"
ssh $sflogin shutdown


